# Клас TASK: задача

**CLSID=16#011x**

## Загальний опис

Представляє собою модель задачі в контексті якої викликається обробка програмних елементів. Реалізується через функціональний блок `TASKFN`, який викликається задачею, за яку відповідає, та відповідним елементом масиву `TASK`.   

Не призначена для обміну з HMI, уся необхідна інформація зчитується та записується функцією `PLCFN`, яка забезпечує координацію та обмін з HMI.

## Примітка щодо версії 2

У версії PACFramework версії 1, TASK не існувало, усі функції були імплементовані в функції PLC. 

## Функціональні вимоги TASKFN

Функція обробки `TASKFN` забезпечує виконання наступних функцій для сутностей що обробляється в контексті задачі:  

- підтвердження широкомовних команд (пропускає через себе широкомовну команду на один цикл), яку виставляє PLC
- фіксує перший скан задачі - на один цикл виставляє відповідний біт в 1 при першому скані
- реалізовує бітові імпульси та меандри які можуть використовуватися в тій же задачі (TASK) де запускається функція
- показує початок години, доби, 
- рахує кількість тривог, ручних станів ВМ, форсувань, тощо по зонам, починаючи від 0 до `A` 
- показує плинний (останній час задачі і максимальний в мс)

## Вимоги щодо реалізації інтерфейсу та програми користувача

`TASKFN` варто реалізовувати як функціональний блок бо необхідно збереження проміжних даних. На вході INOUT вона приймає аргумент `TASK`. На кожну задачу PLC має бути свій виклик `TASKFN` з передачою змінної `TASK`. Передбачається що змінні `TASK` будуть масивом.

Функція обробки `TASKFN` повинна запускатися на початку кожної задачі. Це необхідно для правильної обробки бітів статусу та тривог. 

```pascal
TASKCFN0 (TASKS[0]);
```

## Структура та змінна TASK

`A` - кількість зон - 1 

| name          | type/bit                  | descr                                                        |      | note                        |
| ------------- | ------------------------- | ------------------------------------------------------------ | ---- | --------------------------- |
| ID            | UINT                      | Унікальний номер задачі, він же номер в масиві задач. Виставляється в `PLCFN` при першому скані основної задачі.<br />0 - основна циклічна/періодична задача, в якій запускається `PLCFN`, інші вибираються довільно | M    |                             |
| STA           | ARRAY [0...A] of TASK_STA | Набір бітів типу TASK_STA                                    | M    | `A` = `кількість зон` - `1` |
|               | BLK                       | =1 – є хоча б один заблокований ВМ на весь PAC, виставляється з `PLCFN` |      |                             |
|               | ALDIS                     | =1 – є хоча б одна відключена тривога на весь PAC, виставляється з `PLCFN` |      |                             |
|               | DBLCKALL                  | =1 - усі приводи розблоковані на весь PAC, виставляється з `PLCFN` |      |                             |
|               | FRC                       | =1 – хоча б одна змінна форсована (або ручний режим) на будь якому рівні на весь PAC, виставляється з `PLCFN` |      |                             |
|               | SMLALL                    | =1 – все в режимі в імітації, примушує усі CM перейти в режим імітації на весь PAC, виставляється з `PLCFN` |      |                             |
|               | SML                       | =1 – хоча б один об’єкт в режимі імітації на весь PAC, виставляється з `PLCFN` |      |                             |
|               | DISP                      | =1 – хоча б один елемент в режимі ручного керування на весь PAC, виставляється з `PLCFN` |      |                             |
|               | FRC1                      | =1 – хоча б одна змінна форсована (рівня 1) на весь PAC, виставляється з `PLCFN` |      |                             |
|               | FRC0                      | =1 – хоча б одна змінна форсована (рівня 0) на весь PAC, виставляється з `PLCFN` |      |                             |
|               | SCN1                      | =1 – перший скан задачі після запуску PAC в RUN              |      |                             |
|               | CMDACK                    | =1, коли отримана команда, скидається в 0 перед аналізом як підтвердження команди, команда пройшла через весь цикл задачі і отримана усіма |      |                             |
|               | ALM                       | =1, є хоча б одна тривога аварійного рівня на весь PAC, виставляється з `PLCFN` |      |                             |
|               | NWALM                     | =1, нова тривога аварійного рівня в задачі (виставляється CM, скидається `TASKFN`) |      |                             |
|               | WRN                       | =1, є хоча б одна тривога попереджувального рівня на весь PAC, виставляється з `PLCFN` |      |                             |
|               | NWWRN                     | =1, нова тривога попереджувального рівня в задачі (виставляється CM, скидається `TASKFN`) |      |                             |
|               | BAD                       | =1, є хоча б одна тривога недостовірності на весь PAC, виставляється з `PLCFN` |      |                             |
|               | NWBAD                     | =1, нова тривога недостовірності  в задачі (виставляється CM, скидається `TASKFN`) |      |                             |
| CMD           | UINT                      | Команди з HMI - отримуються з `PLCFN` тільки якщо вони ненульові, перелік команд див. в `PLCFN` | M    |                             |
| PLS           | PLS                       | Набір імпульсних бітів                                       | M    |                             |
|               | P100MS                    | імпульс на один цикл задачі з періодичністю 100 мс (адекватно працюватиме тільки для циклів <50ms) |      |                             |
|               | P200MS                    | 200 мс (адекватно працюватиме тільки для циклів <100ms)      |      |                             |
|               | P500MS                    | 500 мс (адекватно працюватиме тільки для циклів <250ms)      |      |                             |
|               | P1S                       | 1 с                                                          |      |                             |
|               | P2S                       | 2 с                                                          |      |                             |
|               | P5S                       | 5 с                                                          |      |                             |
|               | P10S                      | 10 с                                                         |      |                             |
|               | P60S                      | 1 хв                                                         |      |                             |
|               | M1S                       | меандр з періодом 1 с (0.5 с + 0.5 с) виставляється з `PLCFN` |      |                             |
|               | M2S                       | меандр з періодом 2 с (1 с + 1 с) виставляється з `PLCFN`    |      |                             |
|               | NEWMIN                    | =1 (на один цикл задачі) – початок хвилини                   |      |                             |
|               | NEWHR                     | =1 (на один цикл задачі) – початок години                    |      |                             |
|               | NEWDAY                    | =1 (на один цикл задачі) – початок доби                      |      |                             |
| CNTALM        | ARRAY [0...A] of UINT     | кількість активних тривог "аварія" на кінець задачі          | O    |                             |
| CNTWRN        | ARRAY [0...A] of UINT     | кількість активних тривог "попередження" на кінець задачі    | O    |                             |
| CNTBAD        | ARRAY [0...A] of UINT     | кількість активних тривог "недостовірність" на кінець задачі | O    |                             |
| CNTMAN        | ARRAY [0...A] of UINT     | кількість ВМ в ручному режимі на кінець задачі               | O    |                             |
| CNTFRC0       | ARRAY [0...A] of UINT     | кількість форсованих об'єктів LVL0 на кінець задачі          | O    |                             |
| CNTFRC1       | ARRAY [0...A] of UINT     | кількість форсованих об'єктів LVL1 на кінець задачі          | O    |                             |
| CNTBLK        | ARRAY [0...A] of UINT     | кількість заблокованих ВМ на кінець задачі                   | O    |                             |
| CNTALDIS      | ARRAY [0...A] of UINT     | кількість відключених тривог на кінець задачі                | O    |                             |
| CNTDISP       | ARRAY [0...A] of UINT     | кількість ВМ в режимі ручного диспетчерського керування на кінець задачі | O    |                             |
| CNTSML        | ARRAY [0...A] of UINT     | кількість об'єктів в режимі імітації                         | O    |                             |
| CNTMNBX       | ARRAY [0...A] of UINT     | кількість ВМ в режимі ручного зі щита керування на кінець задачі | O    |                             |
| CNTALM_ACUM   | ARRAY [0...A] of UINT     | накопичувач кількості активних тривог "аварія"               | O    |                             |
| CNTWRN_ACUM   | ARRAY [0...A] of UINT     | накопичувач кількості активних тривог "попередження"         | O    |                             |
| CNTBAD_ACUM   | ARRAY [0...A] of UINT     | накопичувач кількості активних тривог "недостовірність"      | O    |                             |
| CNTMAN_ACUM   | ARRAY [0...A] of UINT     | накопичувач кількості ВМ в ручному режимі                    | O    |                             |
| CNTFRC0_ACUM  | ARRAY [0...A] of UINT     | накопичувач кількості форсованих об'єктів LVL0               | O    |                             |
| CNTFRC1_ACUM  | ARRAY [0...A] of UINT     | накопичувач кількості форсованих об'єктів LVL1               | O    |                             |
| CNTBLK_ACUM   | ARRAY [0...A] of UINT     | накопичувач кількості заблокованих ВМ                        | O    |                             |
| CNTALDIS_ACUM | ARRAY [0...A] of UINT     | накопичувач кількості відключених тривог                     | O    |                             |
| CNTDISP_ACUM  | ARRAY [0...A] of UINT     | накопичувач кількості ВМ в режимі ручного (диспетчерського керування) | O    |                             |
| CNTSML_ACUM   | ARRAY [0...A] of UINT     | накопичувач кількості об'єктів в режимі імітації             | O    |                             |
| CNTMNBX_ACUM  | ARRAY [0...A] of UINT     | накопичувач кількості ВМ в режимі ручного зі щита керування на кінець задачі | O    |                             |
| TSK_LTIME     | UINT                      | плинний (останній) час задачі в мілісекундах, розраховується ззовні `TASKFN` | O    |                             |
| TSK_MAXTIME   | UINT                      | максимальний час задачі в мілісекундах, розраховується ззовні `TASKFN` | O    |                             |
| TQ            | UDINT                     | загальний час з початку 1-го циклу контролера (в секундах) - виставляється з `PLCFN` | M    |                             |
| TQM           | UDINT                     | загальний час роботи ПЛК з моменту першого пуску (в хвилинах) - виставляється з `PLCFN` | O    |                             |
| TQMS          | UDINT                     | мілісекундний лічильник, скидається при старті або після переповнення, для кожної задачі окремо; <br />може бути єдиним для всіх, якщо забезпечити точний підрахунок імпульсів в найчастіше викликаній задачі, тоді виставляється з `PLCFN` | M    |                             |
| NOW           | ARRAY[0..5] of INT        | плинний час астрономічний час: <br />NOW[0] seconds<br />NOW[1] hour, <br />NOW[2] minute <br />NOW[3] month, <br />NOW[4] day; <br />NOW[5] year, | O    | виставляється з `PLCFN`     |

## Тестування `TASKFN`

Цей пункт описує методику перевірки функції TASK в ручному та/або автоматизованому режимі. 

### Перелік тестів

| Номер | Назва                                                 | Коли перевіряти                        | Місце перевірки   |
| ----- | ----------------------------------------------------- | -------------------------------------- | ----------------- |
| 1     | перший скан                                           | після реалізації функції               | симулятор, ПЛК    |
| 2     | бітові імпульси                                       | після реалізації функції разом з PLCFN | симулятор, ПЛК    |
| 3     | імпульси початку години, доби                         | після реалізації функції разом з PLCFN | симулятор, ПЛК    |
| 4     | лічильники (тривог та інші)                           | після реалізації функції разом з PLCFN | симулятор або ПЛК |
| 5     | відображення мінімального та максимального часу циклу | після реалізації функції разом з PLCFN | ПЛК               |
| 6     | обнулення команд через один цикл                      | після реалізації функції               | симулятор або ПЛК |

### 1 Тест першого скану

Ідея тесту передбачає визначення що біт спрацьовує один раз тільки на початку скану задачі. Перевіряти треба на кількох задачах. Тестові змінні повинні зберігати свої значення при зупинці ПЛК (retain). 

- перед запуском перевірки ПЛК повинен бути в СТОП
- перед викликом функції PLCFN повинна інкрементуватися змінна-лічильник циклів `TST.C_TSKS[0]` (де індекс - номер задачі, яка тестується), яка перед запуском ПЛК, повинна =0
- після виклику функції PLCFN при умові, що біт `SCN1=TRUE`:
  - збільшувати змінну `TST.C1_TSKS[0]` (кількість викликів "першого циклу") на 1 
  - присвоїти змінній `TST.NB_TSK[0] := TST.C_TSKS[0]` (останній номер циклу при спрацюванні біта першого циклу)

```pascal
TST.C_TSKS[0] := TST.C_TSKS[0] + 1;
TASK0_FN_DB (TASK:=SYS.TASKS[0]);
if SYS.TASKS[0].STA.SCN1 then
   TST.C1_TSKS[0] := TST.C1_TSKS[0] + 1;
   TST.NB_TSK[0] := TST.C_TSKS[0];
end_if;
```

- після запуску ПЛК `TST.CCLS[0]` повинен збільшуватися, а  `TST.SCN1CLC[0]=1`, `TST.NBCLC[0]=1`

| Крок | дія для перевірки                       | результат                                                    |
| ---- | --------------------------------------- | ------------------------------------------------------------ |
| 1    | обнулити тестові змінні за необхідності |                                                              |
| 2    | запустити ПЛК (імітатор)                |                                                              |
| 3    | перевірити змінні                       | `TST.C_TSKS[0]` збільшується, `TST.C1_TSKS=1, TST.NB_TSK=1`  |
| 4    | зупинити ПЛК                            | лічильники заморозяться                                      |
| 5    | запустити ПЛК                           | `TST.C_TSKS[0]` збільшується, `TST.C1_TSKS=2, TST.NB_TSK=значення при зупинці + 1` |

### 2 Тест бітових імпульсів

- Перевіряється робота бітових імпульсів `P100MS`, `P200MS`, `P500MS`, `P1S`, `P2S`, `P5S`, `P10S`, `P60S`. Імпульси повинні спрацьовувати на один цикл з вказаною періодичністю. Враховуючи прив'язаність до обладнання коректність роботи може гарантуватися тільки на реальному залізі.
- Повторну перевірку варто робити  після реалізації всієї програми користувача, так як об'єм програми впливає на час циклу.   

- Для кожного імпульсу вводиться по одному тестовому лічильнику `TST_P100MS`, `TST_P200MS`, `TST_P500MS`, `TST_P1S`, `TST_P2S`, `TST_P5S`, `TST_P10S`, `TST_P60S`. Також вводиться додаткова змінна `TST_PLSON`, яка забезпечує інтервал тестування. Дана змінна включається для запуску тестування і відключається автоматично при зупинці тестування. 


- Для тестування використовується змінна `TQ` як показник часу. Але точніше буде використовувати системний час. Перевіряється проходження 121 с. Оцінюється приблизна кількість спрацювань з урахуванням похибки.


Якщо кількість імпульсів відрізняється від показника в таблиці, наведеній нижче:

- перевірити правильність реалізації
- якщо реалізація правильна, то очевидно час циклу більше за 2 інтервали бітового імпульсу, треба оцінювати доцільність використання цих бітів в програмі користувача або перевіряти їх на реальному ПЛК (якщо був використаний до цього імітатор)    

Таблиця. Тестові показники для бітових імпульсів.

| Лічильник  | Значення (може відрізнятися) |
| ---------- | ---------------------------- |
| TST_P100MS | 1210                         |
| TST_P200MS | 605                          |
| TST_P500MS | 240                          |
| TST_P1S    | 120-121                      |
| TST_P2S    | 60                           |
| TST_P5S    | 24                           |
| TST_P10S   | 12                           |
| TST_P60S   | 2                            |

```pascal
PLCFN(PLC);
if TST_PLSON then
  if PLC.P100MS then TST_P100MS := TST_P100MS+1; end_if; 
  if PLC.P200MS then TST_P200MS := TST_P200MS +1; end_if;
  if PLC.P500MS then TST_P500MS := TST_P500MS +1; end_if;
  if PLC.P1S then TST_P1S := TST_P1S +1; end_if;
  if PLC.P2S then TST_P2S := TST_P2S +1; end_if;
  if PLC.P5S then TST_P5S := TST_P5S + 1; end_if;
  if PLC.P10S then TST_P10S := TST_P10S + 1; end_if;
  if PLC.P60S then TST_P60S := TST_P60S + 1; end_if;
  if PLC.TQ-TEST_TQPREV>=121 then 
     TST_PLSON:=false;
  end_if; 
else 
  TEST_TQPREV := PLC.TQ;
end_if;
```

| Крок | дія для перевірки                                       | результат                                               |
| ---- | ------------------------------------------------------- | ------------------------------------------------------- |
| 1    | обнулити тестові змінні за необхідності                 |                                                         |
| 2    | запустити ПЛК (імітатор), виставити  `TST_PLSON:=TRUE;` |                                                         |
| 3    | перевірити змінні                                       | результат повинен бути як в таблиці тестових показників |

### 3 Тест імпульсів початку години та доби

Цей тест потребує зміни значення часу в ПЛК або імітаторі.

Перевірка зміни години `NEWHR` перевіряється на першій хвилині (спрацьовує один раз на першій хвилині), доби `NEWDAY` - на першій хвилині першої години доби (спрацьовує один раз на першій хвилині). 

Змінна `TST_CHHRCNT` збільшується на 1 при зміні години, `TST_CHDAYCNT` при зміні доби.

### 4 Тест лічильників 

Усі біти тривог а також біти статусів повинні бути обнулені після виклику функції. Змінні "_PERM" (`STA_PERM` та `ALM1_PERM`) зберігають значення до наступного виклику функції.

Усі лічильники повинні бути скинуті.

### 5 Тест відображення мінімального та максимального часу циклу

Перевірити співпадіння мінімального та максимального значення часу задачі.



### 6 Обнулення команд через один цикл

Перевірити проходження команд протягом одного циклу задачі. Це потрібно для відловлення широкомовних команд. 

Після виклику функції вставляється лічильник коли `PLC.CMD<>0`. Якщо лічильник збільшується на 1 після кожної зміни в ненульове значення `TASKS[0].CMD` виклику команди - все нормально. 

```
IF "SYS".TASKS[0].CMD <> 0 THEN
    "TST".C_CMD[0] := "TST".C_CMD[0] + 1;
END_IF;
```

