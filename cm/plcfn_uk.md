# Клас PLC: програмований контролер

**CLSID=16#21NN** - де NN - номер останньої задачі, за замовченням 2

## Загальний опис

Змінна `PLC` та функціональний блок `PLCFN` відповідають за організацію загально-контролерних функцій, зокрема координація `TASK`, розрахунок статистичних показників та взаємодія з HMI в контексті роботи з усім ПЛК. 

## Примітка щодо версії 2

У версії 2 значно зменшилася структура, та перелік функціональності а також усі задачно-залежні функції. 

Зокрема:

- прибрані дуже рідко використовувані функції, зокрема керування змінами
- зі структури `PLC` видалені `ID` та `CLSID`, так як `PLC` одна на весь PAC
- видалені бітові імпульси (інтервальні, подієві), перший скан, біти активації тривоги, так як вони є задачно-залежними і реалізуються в `TASK`
- добавлена структура `AREA`, яка враховує статистику по зонам   

- біти та лічильники є загальними для зони в задачі, тому вони керуються відповідними функціями задач `TASK`
- для гнучкості передбачається обов'язкові та опціональні поля структури 

`PLCFN` викликається в основній циклічній задачі. 

## Рекомендації щодо використання в HMI

todo

## Функціональні вимоги PLCFN

Функція TASKFN обробляє обов'язкові загальні контролерні дії.  

-   контроль статусів для всього контролеру (наявності блокувань, форсувань, ручних режимів, імітації) зокрема для відображення його на HMI;
-   контроль стану тривог для всього контролеру (наявності аварій, попереджень, помилок каналів) та по зонам (AREA);
-   генерування інтервальних бітових меандрів;
-   визначення плинної дати та часу `NOW` в форматі BCD
-   розрахунок інтегрального показника часу роботи з першого пуску (`TQM`), 
-   розрахунок загального часу роботи з останнього пуску в секундах (`TQ`) 
-   лічильник мілісекунд
-   отримання та відправка широкомовних команд до `TASK`
-   взаємодія з `TASK`: поширення статусів, збір даних з `TASK` і т.п. 
-   виконання загальнокотролерних функцій, якщо вони не пов'язані з якоюсь частиною процесу а саме з усім обладнанням;

### Вимоги щодо реалізації інтерфейсу та програми користувача

`PLCFN` варто реалізовувати як функціональний блок з одним екземпляром. На вході INOUT вона приймає аргументи:

- `PLC` - змінна класу
- `TASKS` - масив задач 

Для бітових представлень можна використовувати як `INT` так `UINT`. У платформі UNITY/CotrolExpert тільки до INT можна звертатися до бітів через крапку. У TIA WinCC тільки INT може використовуватися для тривог. У будь якому випадку передбачається що в SCADA/HMI використовується як бітова матриця. 

Виклик `PLCFN` робиться в основній задачі, перед викликом `TASKFN` що відповідає за цю задачу.  

```pascal
PLCFN (PLC, TASKS);
TASKFN0 (TASKS[0]);
```

При реалізації варто передбачити наступні особливості:

- оброблення першого запуску продублювати як в `TASKS[0]` а не орієнтуватися на нього, бо той викликається пізніше
- можливо необхідне конфігурування системних бітів для першого скану, меандрів тощо 

## Структура та змінна AREA

`AREA` - відповідає за статистику по конкретній області процесу. Це потрібно за необхідності розділення поведінки тривог за різними областями процесу. При виклику обробника `CM`, або `PROC` в якості аргументу передається необов'язковий параметр `ARNO`, який вказує на номер області процеса.   

| name     | type/field | bit  | descr                                                        |      | note |
| -------- | ---------- | ---- | ------------------------------------------------------------ | ---- | ---- |
| STA      | UINT       |      | біти стану для всього ПЛК                                    | M    |      |
|          | ALM        | 0    | =1, є хоча б одна тривога аварійного рівня                   |      |      |
|          | WRN        | 1    | =1, є хоча б одна тривога попереджувального рівня            |      |      |
|          | BAD        | 2    | =1, є хоча б одна тривога недостовірності                    |      |      |
|          | NWALM      | 3    | =1, нова тривога аварійного рівня в задачі (виставляється `TASKFN`, знімається `PLCFN`) |      |      |
|          | NWWRN      | 4    | =1, нова тривога попереджувального рівня в задачі (виставляється `TASKFN`, знімається `PLCFN`) |      |      |
|          | NWBAD      | 5    | =1, нова тривога недостовірності в задачі (виставляється `TASKFN`, знімається `PLCFN`) |      |      |
|          | PALM       | 6    | =1, є хоча б одна тривога процедури                          |      |      |
|          | NWPALM     | 7    | =1, нова тривога процедури                                   |      |      |
|          | b8         | 8    | резерв                                                       |      |      |
|          | ALDIS      | 9    | =1 – є хоча б одна відключена тривога                        |      |      |
|          | DISP       | 10   | =1 – хоча б один елемент в режимі ручного управління         |      |      |
|          | BLK        | 11   | =1 – є хоча б один заблокований ВМ                           |      |      |
|          | FRC1       | 12   | =1 – хоча б одна змінна форсована (рівня 1)                  |      |      |
|          | SCN1       | 13   | =1 – перший скан                                             |      |      |
|          | FRC0       | 14   | =1 – хоча б одна змінна форсована (рівня 0)                  |      |      |
|          | b15        | 15   | резерв                                                       |      |      |
| CNTALM   | UINT       |      | кількість  активних тривог "аварія"                          | O    |      |
| CNTWRN   | UINT       |      | кількість  активних тривог "попередження"                    | O    |      |
| CNTBAD   | UINT       |      | кількість  активних тривог "недостовірність"                 | O    |      |
| CNTFRC0  | UINT       |      | кількість форсованих об'єктів LVL0                           | O    |      |
| CNTFRC1  | UINT       |      | кількість форсованих об'єктів LVL1                           | O    |      |
| CNTMNBX  | UINT       |      | кількість ВМ в ручному режимі                                | O    |      |
| CNTBLK   | UINT       |      | кількість заблокованих ВМ                                    | O    |      |
| CNTALDIS | UINT       |      | кількість відключених тривог                                 | O    |      |
| CNTDISP  | UINT       |      | кількість ВМ в режимі ручного керування                      | O    |      |

## Структура та змінна PLC

### Опис структури

Наведена нижче структура адаптована під імпорт в формат CSV з урахуванням можливості подальшого перетворення у зручний для платформи формат:

`name` - ім'я параметру

`type` - тип параметру

`adr` - зміщення відповідно до початку структури (в 16-бітних словах)

`bit` - номер біта в 16-бітній структурі

`field` - назва біта

`descr` - опис 

`A` = `кількість зон` - `1` 

| name  | type/field            | bit  | descr                                                        |      | note                    |
| ----- | --------------------- | ---- | ------------------------------------------------------------ | ---- | ----------------------- |
| TQ    | UDINT                 |      | загальний час з початку 1-го циклу контролера (в секундах)   | M    |                         |
| TQM   | UDINT                 |      | загальний час роботи ПЛК з моменту пуску (в хвилинах), потребує збереження в Retentive | M    |                         |
| TQMS  | UDINT                 |      | мілісекундний лічильник, скидається при старті або після переповнення | M    |                         |
| NOW   | ARRAY[0..5] of INT    |      | плинний час астрономічний час: <br />NOW[0] seconds<br />NOW[1] hour, <br />NOW[2] minute <br />NOW[3] month, <br />NOW[4] day; <br />NOW[5] year, | O    | виставляється з `PLCFN` |
| STA   | UINT                  |      | біти стану для всього ПЛК                                    | M    |                         |
|       | ALM                   | 0    | =1, є хоча б одна тривога аварійного рівня                   |      |                         |
|       | WRN                   | 1    | =1, є хоча б одна тривога попереджувального рівня            |      |                         |
|       | BLK                   | 2    | =1 – є хоча б один заблокований ВМ                           |      |                         |
|       | ALDIS                 | 3    | =1 – є хоча б одна відключена тривога                        |      |                         |
|       | M1S                   | 4    | меандр з періодом 1 с (0.5 с + 0.5 с)                        |      |                         |
|       | M2S                   | 5    | меандр з періодом 2 с (1 с + 1 с)                            |      |                         |
|       | DBLCKALL              | 6    | =1 - усі приводи розблоковані                                |      |                         |
|       | PALM                  | 7    | =1 - є хоча б одна тривога процедури                         |      |                         |
|       | SMLALL                | 8    | =1 – все в режимі в імітації, примушує усі CM перейти в режим імітації |      |                         |
|       | SML                   | 9    | =1 – хоча б один об’єкт в режимі імітації                    |      |                         |
|       | DISP                  | 10   | =1 – хоча б один елемент в режимі ручного управління         |      |                         |
|       | b11                   | 11   | резерв                                                       |      |                         |
|       | FRC1                  | 12   | =1 – хоча б одна змінна форсована (рівня 1)                  |      |                         |
|       | SCN1                  | 13   | =1 – перший скан                                             |      |                         |
|       | FRC0                  | 14   | =1 – хоча б одна змінна форсована (рівня 0)                  |      |                         |
|       | BAD                   | 15   | =1, є хоча б одна тривога недостовірності                    |      |                         |
| CMD   | UINT                  |      | Команди з HMI:16#0100 – прочитати конфігурацію;<br />16#0101 – записати конфігурацію; <br />16#301 - включити режим деблокування усіх ВМ; <br />16#302 - відключити режим деблокування усіх ВМ;  <br />16#300 - перемкнути режим деблокування усіх ВМ;  <br />    16#0111 – синхронізувати час з верхнім рівнем;<br /> 16#0301 – вимкнути сирену; 16#0302 – увімкнути сирену; <br />16#4101 – записати конфігурація за замовченням для усіх змінних DIVAR; <br />16#4102 – записати конфігурація за замовченням для усіх змінних AIVAR; <br />16#4103 – записати конфігурація за замовченням для усіх змінних DOVAR; <br />16#4104 – записати конфігурація за замовченням для усіх змінних AOVAR;<br />16#4301 – форсувати всі об'єкти LVL0; <br />16#4302 – дефорсувати всі об'єкти LVL0;1<br />6#4303 – форсувати всі об'єкти LVL1;<br />16#4304 – дефорсувати всі об'єкти LVL1<br />16#5xyy - користувацькі команди для рівня LVLx (рекомендується описувати в одному місці ) <br /> | M    |                         |
| AREAS | ARRAY [0...A] of AREA |      | статистика та біти стану по зонам                            |      |                         |



### Використання змінних типу PLC_CFG

Для кожного ПЛК створюється по одній змінній типу PLC_CFG. Вона використовується в якості аргументу для усіх функцій та функціональних блоків, які реалізовують процедурне та базове керування. Якщо з функції або ФБ з середини дозволяється викликати глобальні дані, для покращення читабельності можна в інтерфейс цих функцій змінну не включати.   

PLC_CFG можна використовувати в розподіленому керуванні (декілька ПЛК) для обміну між ПЛК їх загальним статусом/командами, що може спростити їх координацію. У такому випадку, наявність буферних змінних і унікального ID може бути використано для конфігурування/контролю декількох ПЛК з одного HMI, через ПЛК-проксі. Так, наприклад, змінна TQ може бути використана для контролю за станом ПЛК або зв'язку з ним, адже якщо ця змінна не змінюється протягом тривалого часу, цей ПЛК знаходиться в стопі або недоступний (щось на кшталт heart_beat).

Деякі біти полів STA, та усі біти ALM1, ALM2 скидаються на початку задачі функцією PLCFN. Це зроблено для того, щоб будь який з CM/EM/Unit міг виставити біт в 1, тим самим сигналізуючи про твердження "хоча б один".

Поле MSG – може бути використано для формування повідомлень оператору, на кшталт – не можу виконати команду. Таке поле може бути і в інших структурах CM/EM/UNIT, тоді воно повинно бути в структурі HMI. Як варіант економії ресурсів може бути одне поле MSG на всі повідомлення. Якщо це поле буде бітовим, то повідомлення не будуть перекриватися, однак їх кількість буде обмежено 32 на весь ПЛК. Тим не менше, кількість полів MSG можна збільшувати до необхідного. Враховуючи, що повідомлення формуються по тригеру, їх необхідно "очищувати", що може бути зроблено за таймером або з самого HMI, як приймача повідомлення (наприклад додатковою командою ACKMSG – прийняв повідомлення). Механізми очищення виробляються для конкретного випадку.

## Тестування PLCFN 

todo

Цей пункт описує методику перевірки функції PLCFN в ручному та/або автоматизованому режимі. 

### Перелік тестів

| Номер | Назва                                        | Коли перевіряти                                              | Примітки |
| ----- | -------------------------------------------- | ------------------------------------------------------------ | -------- |
| 2     | астрономічний час                            | після реалізації функції                                     |          |
| 3     | лічильники роботи ПЛК: загальний і зі старту | після реалізації функції                                     |          |
| 5     | бітові меандри                               | після реалізації функції, у кінці проекту на реальному ПК, щоб перевірити адекватність |          |
| 10    | обнулення команд через один цикл             | після реалізації функції                                     |          |

### 1 Тест першого скану

todo

